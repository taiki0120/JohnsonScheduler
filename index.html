<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>JohnsonScheduler</title>
<style>
  /* ----- ベーシック CSS ----- */
  :root{
    --bg:#f7f8fa;
    --card:#ffffff;
    --accent:#2b6df6;
    --muted:#6b7280;
    --line:#e6e9ef;
    --radius:8px;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  html,body{height:100%; margin:0; background:var(--bg); color:#111;}
  .container{
    max-width:1000px;
    margin:28px auto;
    padding:20px;
  }
  header{display:flex; align-items:center; gap:12px; margin-bottom:14px;}
  header h1{margin:0; font-size:20px;}
  header p{margin:0; color:var(--muted); font-size:13px;}
  .card{
    background:var(--card);
    border-radius:var(--radius);
    padding:16px;
    box-shadow: 0 1px 0 rgba(16,24,40,0.03);
    border:1px solid var(--line);
    margin-bottom:12px;
  }

  /* tabs */
  .tabs{display:flex; gap:8px; margin-bottom:12px;}
  .tab{
    padding:8px 12px; border-radius:6px; cursor:pointer;
    background:transparent; color:var(--muted); border:1px solid transparent;
  }
  .tab.active{
    background:linear-gradient(90deg,var(--accent), #2762d9);
    color:white; box-shadow:0 2px 6px rgba(43,109,246,0.12);
  }

  /* layout */
  .flex{display:flex; gap:12px;}
  .col{flex:1;}
  textarea{
    width:100%; min-height:150px; resize:vertical;
    padding:10px; border-radius:6px; border:1px solid var(--line);
    font-family: monospace; font-size:13px;
  }
  label.small{display:block; font-size:13px; color:var(--muted); margin-bottom:6px;}

  .controls{display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap;}
  button{
    background:var(--accent); color:white; border:0; padding:8px 12px;
    border-radius:6px; cursor:pointer;
  }
  button.ghost{
    background:transparent; color:var(--accent); border:1px solid var(--line);
  }
  input[type="number"]{width:80px; padding:8px; border-radius:6px; border:1px solid var(--line);}

  /* table input */
  table.input-table{width:100%; border-collapse:collapse; margin-top:8px;}
  table.input-table td, table.input-table th{
    border-bottom:1px solid var(--line); padding:8px; text-align:left;
  }
  .small-btn{padding:6px 8px; font-size:13px;}

  /* results */
  .results .section{margin-top:12px;}
  .sequence{font-weight:600; margin-bottom:8px;}
  pre{background:#fbfcff; padding:10px; border-radius:6px; font-size:13px; overflow:auto; border:1px solid var(--line);}

  /* gantt */
  #gantt-wrap{margin-top:12px; border-radius:6px; padding:12px; background:#ffffff; border:1px solid var(--line);}
  canvas#gantt{width:100%; height:240px; display:block; background:linear-gradient(180deg,#ffffff,#fbfdff); border-radius:6px;}

  /* responsive */
  @media(max-width:720px){
    .flex{flex-direction:column;}
    input[type="number"]{width:100%;}
    button{width:100%;}
  }
</style>
</head>
<body>
  <div class="container">

    <header>
      <div>
        <h1>JohnsonScheduler</h1>
        <p>Johnson法で最適順序を計算し、ガントチャートを表示します</p>
      </div>
    </header>

    <!-- 入力カード -->
    <div class="card">
      <div class="tabs" role="tablist">
        <div class="tab active" id="tab-text" role="tab">文字入力（CSV）</div>
        <div class="tab" id="tab-table" role="tab">表入力</div>
      </div>

      <div id="panel-text">
        <label class="small">下の形式で入力。コピー&ペーストで素早く登録できます。<span style="color:var(--muted)">（job名,Machine1,Machine2）</span></label>
        <textarea id="text-input" placeholder="例：&#10;job1,3,10&#10;job2,7,4&#10;job3,5,9"></textarea>
        <div class="controls">
          <button id="parse-text">表に反映（表入力へ）</button>
          <button id="calc-from-text">計算する</button>
          <button class="ghost" id="clear-text">クリア</button>
        </div>
      </div>

      <div id="panel-table" style="display:none;">
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <label class="small">ジョブ数</label>
          <input id="job-count" type="number" min="1" value="3" />
          <button id="gen-rows" class="small-btn">反映</button>
        </div>

        <div style="overflow:auto; margin-top:8px;">
          <table class="input-table" id="job-table" aria-label="job table">
            <thead>
              <tr><th>Job名</th><th>Machine1</th><th>Machine2</th><th>操作</th></tr>
            </thead>
            <tbody id="job-tbody">
              <!-- rows generated by JS -->
            </tbody>
          </table>
        </div>

        <div class="controls">
          <button id="add-row">行を追加</button>
          <button id="calc-from-table">計算する</button>
          <button class="ghost" id="clear-table">クリア</button>
        </div>
      </div>
    </div>

    <!-- 結果 -->
    <div class="card results" id="results-card" style="display:none;">
      <div class="section">
        <div class="sequence">Johnson 最適順序： <span id="sequence-text"></span></div>
      </div>

      <div class="section">
        <label class="small">スケジュール表（Machine1→Machine2）</label>
        <div id="schedule-area"></div>
      </div>

      <div class="section">
        <label class="small">ガントチャート</label>
        <div id="gantt-wrap">
          <canvas id="gantt"></canvas>
        </div>
      </div>

      <div style="margin-top:10px;">
        <button id="download-csv">CSVダウンロード（スケジュール表）</button>
        <button class="ghost" id="clear-results">結果をクリア</button>
      </div>
    </div>

    <footer style="margin-top:10px; color:var(--muted); font-size:13px;">
      <div>JohnsonScheduler — 単純2機械ジョブショップ（Johnson法）</div>
    </footer>
  </div>

<script>
/* ----------------------
   JohnsonScheduler - Single-file JS
   - タブ切替
   - 文字入力パース
   - 表入力編集（行追加・削除）
   - Johnson algorithm
   - スケジュール計算
   - ガントチャート描画（canvas）
   - CSVダウンロード
   ---------------------- */

/* ----- ユーティリティ ----- */
const $ = id => document.getElementById(id);
const clamp = (v,min,max) => Math.max(min, Math.min(max, v));

/* ----- タブ制御 ----- */
const tabText = $('tab-text'), tabTable = $('tab-table');
const panelText = $('panel-text'), panelTable = $('panel-table');

tabText.addEventListener('click', ()=> {
  tabText.classList.add('active'); tabTable.classList.remove('active');
  panelText.style.display='block'; panelTable.style.display='none';
});
tabTable.addEventListener('click', ()=> {
  tabTable.classList.add('active'); tabText.classList.remove('active');
  panelTable.style.display='block'; panelText.style.display='none';
});

/* ----- 初期テーブル行生成 ----- */
const jobTbody = $('job-tbody');
function makeRow(jobName='', m1=0, m2=0){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input class="job-name" type="text" value="${jobName}" style="width:100%; padding:6px; border-radius:6px; border:1px solid #e6e9ef;" /></td>
    <td><input class="m1" type="number" min="0" value="${m1}" style="width:100px; padding:6px; border-radius:6px; border:1px solid #e6e9ef;" /></td>
    <td><input class="m2" type="number" min="0" value="${m2}" style="width:100px; padding:6px; border-radius:6px; border:1px solid #e6e9ef;" /></td>
    <td><button class="remove small-btn">削除</button></td>
  `;
  tr.querySelector('.remove').addEventListener('click', ()=> tr.remove());
  return tr;
}

function genRows(count){
  jobTbody.innerHTML='';
  for(let i=0;i<count;i++){
    const name = `Job${i+1}`;
    jobTbody.appendChild(makeRow(name, (i+1)*2, Math.max(1,5-i)));
  }
}
/* 初期3行 */
genRows(3);

/* ----- ボタンイベント（表） ----- */
$('gen-rows').addEventListener('click', ()=>{
  const n = parseInt($('job-count').value) || 0;
  if(n<1){ alert('ジョブ数は1以上で入力してください'); return; }
  genRows(n);
});
$('add-row').addEventListener('click', ()=> {
  const idx = jobTbody.children.length + 1;
  jobTbody.appendChild(makeRow(`Job${idx}`, 1, 1));
});
$('clear-table').addEventListener('click', ()=> { if(confirm('表をクリアしますか？')) genRows(0); });

/* ----- テキストエリア関連 ----- */
$('clear-text').addEventListener('click', ()=> { $('text-input').value=''; });
$('parse-text').addEventListener('click', ()=> {
  const text = $('text-input').value.trim();
  if(!text){ alert('テキストが空です'); return; }
  const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(l=>l && !l.startsWith('#'));
  const rows = [];
  for(const l of lines){
    // accept comma, tab, or spaces
    const parts = l.split(/[, \t]+/).map(p=>p.trim()).filter(Boolean);
    if(parts.length < 2){ alert('形式不正な行があります：\n' + l); return; }
    const name = parts[0];
    const m1 = Number(parts[1]);
    const m2 = Number(parts[2] ?? NaN);
    if(Number.isNaN(m1) || Number.isNaN(m2)){ alert('数値に変換できない値があります：\n' + l); return; }
    rows.push({name,m1,m2});
  }
  // reflect into table
  jobTbody.innerHTML='';
  rows.forEach(r=> jobTbody.appendChild(makeRow(r.name, r.m1, r.m2)));
  tabTable.click(); // switch to table for review
});

/* ----- 入力パース ----- */
function readFromTable(){
  const rows = [];
  const trs = Array.from(jobTbody.children);
  for(let i=0;i<trs.length;i++){
    const tr = trs[i];
    const name = (tr.querySelector('.job-name').value || `Job${i+1}`).trim();
    const m1 = Number(tr.querySelector('.m1').value);
    const m2 = Number(tr.querySelector('.m2').value);
    if(!Number.isFinite(m1) || !Number.isFinite(m2) || m1<0 || m2<0){
      throw new Error(`行${i+1} の Machine 時間は 0 以上の数値で入力してください`);
    }
    rows.push({id:i+1, name, m1:Math.round(m1), m2:Math.round(m2)});
  }
  if(rows.length === 0) throw new Error('少なくとも1つのジョブを入力してください。');
  return rows;
}

function readFromText(){
  const raw = $('text-input').value.trim();
  if(!raw) throw new Error('テキスト入力が空です。');
  const lines = raw.split(/\r?\n/).map(l=>l.trim()).filter(l=>l && !l.startsWith('#'));
  const rows = [];
  for(let i=0;i<lines.length;i++){
    const l = lines[i];
    const parts = l.split(/[, \t]+/).map(p=>p.trim()).filter(Boolean);
    if(parts.length < 3) throw new Error(`行 ${i+1} の形式が不正です（job, m1, m2 の順）: ${l}`);
    const name = parts[0] || `Job${i+1}`;
    const m1 = Number(parts[1]), m2 = Number(parts[2]);
    if(!Number.isFinite(m1) || !Number.isFinite(m2) || m1<0 || m2<0) throw new Error(`行 ${i+1} の Machine 時間は0以上の数値で入力してください: ${l}`);
    rows.push({id:i+1, name, m1:Math.round(m1), m2:Math.round(m2)});
  }
  return rows;
}

/* ----- Johnson algorithm ----- */
function johnson(jobs){
  // jobs: [{id,name,m1,m2}, ...]
  const left = [], right = [];
  const remaining = jobs.slice();
  while(remaining.length>0){
    // find job with minimal min(m1, m2)
    let minIdx = 0;
    let minVal = Math.min(remaining[0].m1, remaining[0].m2);
    for(let i=1;i<remaining.length;i++){
      const v = Math.min(remaining[i].m1, remaining[i].m2);
      if(v < minVal){
        minVal = v; minIdx = i;
      }
    }
    const job = remaining.splice(minIdx,1)[0];
    if(job.m1 <= job.m2){
      left.push(job);
    } else {
      right.unshift(job);
    }
  }
  return left.concat(right);
}

/* ----- スケジュール計算 ----- */
function calcSchedule(sequence){
  // sequence: [{id,name,m1,m2}, ...] in order to process
  const schedule = []; // array of {job, m1s, m1e, m2s, m2e}
  let t1 = 0, t2 = 0;
  for(const job of sequence){
    const m1s = t1;
    const m1e = m1s + job.m1;
    const m2s = Math.max(m1e, t2);
    const m2e = m2s + job.m2;
    schedule.push({job, m1s, m1e, m2s, m2e});
    t1 = m1e;
    t2 = m2e;
  }
  const makespan = schedule.length ? schedule[schedule.length-1].m2e : 0;
  return {schedule, makespan};
}

/* ----- 表示アップデート ----- */
const resultsCard = $('results-card');
const seqText = $('sequence-text');
const scheduleArea = $('schedule-area');

function renderScheduleTable(scheduleObj){
  const s = scheduleObj.schedule;
  let html = '<table style="width:100%; border-collapse:collapse; font-size:13px;"><thead><tr style="background:#fbfdff;"><th style="padding:8px;border:1px solid var(--line)">Job</th><th style="padding:8px;border:1px solid var(--line)">M1開始</th><th style="padding:8px;border:1px solid var(--line)">M1終了</th><th style="padding:8px;border:1px solid var(--line)">M2開始</th><th style="padding:8px;border:1px solid var(--line)">M2終了</th></tr></thead><tbody>';
  for(const row of s){
    html += `<tr><td style="padding:8px;border:1px solid var(--line)">${escapeHtml(row.job.name)}</td><td style="padding:8px;border:1px solid var(--line)">${row.m1s}</td><td style="padding:8px;border:1px solid var(--line)">${row.m1e}</td><td style="padding:8px;border:1px solid var(--line)">${row.m2s}</td><td style="padding:8px;border:1px solid var(--line)">${row.m2e}</td></tr>`;
  }
  html += '</tbody></table>';
  html += `<div style="margin-top:8px; color:var(--muted)">Makespan（総所要時間）: <strong>${scheduleObj.makespan}</strong></div>`;
  scheduleArea.innerHTML = html;
}

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, (m)=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* ----- ガントチャート描画 ----- */
function drawGantt(scheduleObj){
  const canvas = $('gantt');
  const dpr = window.devicePixelRatio || 1;
  const wrap = document.getElementById('gantt-wrap');
  const rect = wrap.getBoundingClientRect();
  const width = Math.max(600, rect.width - 24);
  const height = 260;
  canvas.width = Math.floor(width * dpr);
  canvas.height = Math.floor(height * dpr);
  canvas.style.width = width + 'px';
  canvas.style.height = height + 'px';
  const ctx = canvas.getContext('2d');
  ctx.scale(dpr,dpr);
  ctx.clearRect(0,0,width,height);
  // layout
  const paddingLeft = 80;
  const paddingRight = 24;
  const top = 24;
  const rowHeight = 56;
  const gap = 12;
  const totalWidth = width - paddingLeft - paddingRight;
  const makespan = scheduleObj.makespan || 1;
  const scale = totalWidth / makespan;

  // labels
  ctx.fillStyle = '#111';
  ctx.font = '13px system-ui, -apple-system, "Segoe UI", Roboto';
  ctx.fillText('Machine1', 8, top + 14);
  ctx.fillText('Machine2', 8, top + rowHeight + 14);

  // draw background rows
  ctx.fillStyle = '#fbfdff';
  ctx.fillRect(paddingLeft-6, top-6, totalWidth+12, rowHeight+8);
  ctx.fillRect(paddingLeft-6, top + rowHeight -6, totalWidth+12, rowHeight+8);

  // draw time grid
  ctx.strokeStyle = '#eef2ff';
  ctx.lineWidth = 1;
  ctx.beginPath();
  for(let t=0; t<=makespan; t++){
    const x = paddingLeft + t*scale;
    if(x > paddingLeft + totalWidth) break;
    ctx.moveTo(x, top-4); ctx.lineTo(x, top + rowHeight*2 + 8);
  }
  ctx.stroke();

  // draw bars
  const s = scheduleObj.schedule;
  for(let i=0;i<s.length;i++){
    const row = s[i];
    const color = jobColor(i, s.length);
    // M1 bar
    const x1 = paddingLeft + row.m1s * scale;
    const w1 = Math.max(2, (row.m1e - row.m1s) * scale);
    const y1 = top + 6;
    roundRect(ctx, x1, y1, w1, rowHeight-20, 6, color);
    // label
    ctx.fillStyle = '#fff';
    ctx.font = '12px system-ui';
    ctx.fillText(row.job.name, x1 + 6, y1 + 16);

    // M2 bar
    const x2 = paddingLeft + row.m2s * scale;
    const w2 = Math.max(2, (row.m2e - row.m2s) * scale);
    const y2 = top + rowHeight + 6;
    roundRect(ctx, x2, y2, w2, rowHeight-20, 6, color);
    ctx.fillStyle = '#fff';
    ctx.fillText(row.job.name, x2 + 6, y2 + 16);
  }

  // time axis (every 1 unit or step)
  ctx.fillStyle = '#6b7280';
  ctx.font = '12px system-ui';
  for(let t=0;t<=makespan;t++){
    const x = paddingLeft + t*scale;
    if(x > paddingLeft + totalWidth) break;
    ctx.fillText(String(t), x-6, top + rowHeight*2 + 26);
  }
}

// helper: rounded rect fill
function roundRect(ctx,x,y,w,h,r,color){
  ctx.fillStyle = color;
  ctx.beginPath();
  ctx.moveTo(x+r, y);
  ctx.lineTo(x+w-r, y);
  ctx.quadraticCurveTo(x+w, y, x+w, y+r);
  ctx.lineTo(x+w, y+h-r);
  ctx.quadraticCurveTo(x+w, y+h, x+w-r, y+h);
  ctx.lineTo(x+r, y+h);
  ctx.quadraticCurveTo(x, y+h, x, y+h-r);
  ctx.lineTo(x, y+r);
  ctx.quadraticCurveTo(x, y, x+r, y);
  ctx.closePath();
  ctx.fill();
}

// color generator (distinct-ish)
function jobColor(i, total){
  const hue = Math.round((i * (360/(Math.max(total,1)+1))) % 360);
  return `hsl(${hue} 85% 45% / 0.95)`;
}

/* ----- CSV ダウンロード ----- */
function scheduleToCSV(scheduleObj){
  const rows = scheduleObj.schedule.map(r => [
    r.job.name, r.job.m1, r.job.m2, r.m1s, r.m1e, r.m2s, r.m2e
  ]);
  const header = ['Job','M1','M2','M1_start','M1_end','M2_start','M2_end'];
  const csv = [header, ...rows].map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
  return csv;
}

$('download-csv').addEventListener('click', ()=>{
  if(!window._lastSchedule){ alert('まずは計算を実行してください'); return; }
  const csv = scheduleToCSV(window._lastSchedule);
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'johnson_schedule.csv';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
});

/* ----- 主要アクション: 計算ボタン ----- */
function runFromTable(){
  try{
    const jobs = readFromTable();
    doCalculate(jobs);
  }catch(e){
    alert(e.message || e);
  }
}
function runFromText(){
  try{
    const jobs = readFromText();
    // auto-reflect to table for review
    jobTbody.innerHTML='';
    jobs.forEach(j => jobTbody.appendChild(makeRow(j.name, j.m1, j.m2)));
    tabTable.click();
    doCalculate(jobs);
  }catch(e){ alert(e.message || e); }
}

$('calc-from-table').addEventListener('click', runFromTable);
$('calc-from-text').addEventListener('click', runFromText);
$('clear-results').addEventListener('click', ()=> {
  resultsCard.style.display='none';
  scheduleArea.innerHTML='';
  $('sequence-text').textContent='';
  window._lastSchedule = null;
});

/* compute sequence -> schedule -> render */
function doCalculate(jobs){
  // jobs: [{id,name,m1,m2}, ...]
  if(!Array.isArray(jobs) || jobs.length === 0) { alert('ジョブが空です'); return; }
  const sequence = johnson(jobs);
  const scheduleObj = calcSchedule(sequence);
  // display
  seqText.textContent = sequence.map(j=>j.name).join(' → ');
  renderScheduleTable(scheduleObj);
  drawGantt(scheduleObj);
  resultsCard.style.display = 'block';
  window._lastSchedule = scheduleObj;
}

/* ----- misc helpers ----- */
$('text-input').addEventListener('keydown', (e)=> {
  if((e.ctrlKey || e.metaKey) && e.key === 'Enter'){ runFromText(); }
});
$('clear-results').addEventListener('click', ()=> {
  resultsCard.style.display='none';
});
$('calc-from-text').addEventListener('click', ()=> {});
$('calc-from-table').addEventListener('click', ()=> {});

/* initial example */
(function init(){
  // sample in text area
  $('text-input').value = 'job1,3,10\njob2,7,4\njob3,5,9';
})();
</script>
</body>
</html>

