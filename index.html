<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Process Optimizer DX | Production Scheduler</title>
<style>
  /* ----- ãƒ™ãƒ¼ã‚·ãƒƒã‚¯ CSS ----- */
  :root{
    --bg:#f4f6f8;
    --card:#ffffff;
    --accent:#0052cc; /* ä¿¡é ¼ã®ãƒ–ãƒ«ãƒ¼ */
    --accent-dark:#0747a6;
    --success:#00875a; /* ã‚ˆã‚Šæ·±ã„ç·‘ã§Professionalæ„Ÿã‚’ */
    --success-bg:#e3fcef;
    --danger:#ff5630;
    --muted:#6b778c;
    --line:#dfe1e6;
    --radius:6px; /* å°‘ã—ãƒ¢ãƒ€ãƒ³ã« */
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  }
  html,body{height:100%; margin:0; background:var(--bg); color:#172b4d; font-size:14px; line-height:1.5;}
  
  .container{
    max-width:1100px;
    margin:0 auto;
    padding:40px 20px;
  }

  /* Header area */
  header{ margin-bottom:30px; border-bottom:1px solid var(--line); padding-bottom:20px; }
  header h1{ margin:0; font-size:28px; font-weight:700; color:#172b4d; letter-spacing:-0.5px; }
  header p{ margin:8px 0 0; color:var(--muted); font-size:15px; }
  header .badge-pro{ 
    background:var(--accent); color:white; font-size:11px; padding:2px 8px; 
    border-radius:10px; vertical-align:middle; margin-left:10px; font-weight:600;
  }
  
  .card{
    background:var(--card);
    border-radius:var(--radius);
    padding:24px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08), 0 4px 12px rgba(0,0,0,0.05);
    margin-bottom:24px;
    transition: box-shadow 0.3s ease;
  }
  .card:hover{ box-shadow: 0 4px 6px rgba(0,0,0,0.1), 0 10px 20px rgba(0,0,0,0.08); }

  /* tabs */
  .tabs{display:flex; gap:12px; margin-bottom:20px; border-bottom:2px solid var(--line);}
  .tab{
    padding:10px 20px; cursor:pointer; font-weight:600; font-size:14px;
    color:var(--muted); border-bottom:2px solid transparent; margin-bottom:-2px;
    transition: all 0.2s;
  }
  .tab:hover{ color:var(--accent); }
  .tab.active{
    border-bottom-color:var(--accent); color:var(--accent); 
  }

  /* forms */
  textarea{
    width:100%; min-height:150px; resize:vertical;
    padding:16px; border-radius:var(--radius); border:2px solid var(--line);
    font-family: "SF Mono", "Monaco", "Inconsolata", monospace; font-size:14px; 
    box-sizing: border-box; outline:none; transition:0.2s;
  }
  textarea:focus{ border-color:var(--accent); }

  label.section-label{
    display:block; font-size:12px; font-weight:700; color:var(--muted); 
    margin-bottom:8px; text-transform:uppercase; letter-spacing:0.8px;
  }

  .controls{display:flex; gap:12px; align-items:center; margin-top:16px; flex-wrap:wrap;}
  
  button{
    background:var(--accent); color:white; border:0; padding:10px 20px;
    border-radius:var(--radius); cursor:pointer; font-weight:600; 
    transition:0.2s; font-size:14px; display:inline-flex; align-items:center; gap:6px;
  }
  button:hover{background:var(--accent-dark); transform:translateY(-1px);}
  button:active{transform:translateY(1px);}
  
  button.ghost{
    background:transparent; color:var(--muted); border:2px solid var(--line);
  }
  button.ghost:hover{background:#f4f5f7; color:#172b4d; border-color:#c1c7d0;}
  
  button.secondary{ background:#42526e; }
  
  input[type="number"], input[type="text"]{
    padding:8px 12px; border-radius:var(--radius); border:2px solid var(--line); outline:none;
  }
  input:focus{ border-color:var(--accent); }

  /* table input */
  table.input-table{width:100%; border-collapse:collapse; margin-top:8px;}
  table.input-table th{
    background:#f4f5f7; color:var(--muted); font-size:12px; text-align:left; padding:10px; font-weight:700;
  }
  table.input-table td{border-bottom:1px solid var(--line); padding:8px;}
  .small-btn{padding:4px 10px; font-size:12px; background:#dfe1e6; color:#172b4d; height:auto; border:none;}
  .small-btn:hover{background:#c1c7d0;}

  /* --- KPI Dashboard --- */
  .kpi-board{
    display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap:20px; margin-bottom:24px;
  }
  .kpi-card{
    background:#f9fafb; padding:20px; border-radius:var(--radius); 
    border:1px solid var(--line); position:relative; overflow:hidden;
  }
  .kpi-card::before{
    content:''; position:absolute; left:0; top:0; bottom:0; width:4px; background:var(--muted);
  }
  .kpi-card.success{ background:var(--success-bg); border-color:#b3d4ff; }
  .kpi-card.success::before{ background:var(--success); }
  
  .kpi-card h3{ margin:0 0 8px; font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:1px; font-weight:700;}
  .kpi-card .value{ font-size:32px; font-weight:800; color:#172b4d; line-height:1.1;}
  .kpi-card .sub{ font-size:13px; color:var(--muted); margin-top:4px; }
  
  .badge{
    display:inline-block; padding:3px 8px; border-radius:4px; 
    font-size:12px; font-weight:700; vertical-align:middle; margin-left:8px;
  }
  .badge-green{background:var(--success); color:white;}

  /* results */
  .sequence-box{
    padding:16px; background:#e3fcef; border-radius:var(--radius); 
    color:#006644; border:1px solid #b3d4ff; font-weight:600; margin-bottom:20px;
    display:flex; align-items:center; gap:10px;
  }
  
  #gantt-wrap{
    margin-top:12px; border-radius:var(--radius); 
    padding:20px; background:#ffffff; border:1px solid var(--line);
    position:relative;
  }
  canvas#gantt{width:100%; height:280px; display:block;}

  /* table result */
  .res-table{width:100%; border-collapse:collapse; font-size:13px;}
  .res-table th{border-bottom:2px solid var(--line); padding:10px; text-align:left; color:var(--muted);}
  .res-table td{border-bottom:1px solid var(--line); padding:10px;}
  .res-table tr:last-child td{border-bottom:none;}

  @media(max-width:720px){
    .kpi-board{grid-template-columns: 1fr;}
    button{width:100%; justify-content:center;}
  }
</style>
</head>
<body>
  <div class="container">

    <header>
      <h1>Production Scheduler DX <span class="badge-pro">PRO</span></h1>
      <p>Johnsonæ³•ã«ã‚ˆã‚‹2å·¥ç¨‹ãƒ•ãƒ­ãƒ¼ã‚·ãƒ§ãƒƒãƒ—å‹ ç”Ÿç”£ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°æœ€é©åŒ–ãƒ„ãƒ¼ãƒ«</p>
    </header>

    <div class="card">
      <div class="tabs" role="tablist">
        <div class="tab active" id="tab-text">CSV/ãƒ†ã‚­ã‚¹ãƒˆè²¼ä»˜</div>
        <div class="tab" id="tab-table">ãƒ†ãƒ¼ãƒ–ãƒ«ç·¨é›†</div>
      </div>

      <div id="panel-text">
        <label class="section-label">ãƒ‡ãƒ¼ã‚¿å…¥åŠ› (å½¢å¼: ãƒ­ãƒƒãƒˆå, ç¬¬1å·¥ç¨‹æ™‚é–“, ç¬¬2å·¥ç¨‹æ™‚é–“)</label>
        <textarea id="text-input" placeholder="ä¾‹ï¼š&#10;Lot-A, 30, 100&#10;Lot-B, 70, 40&#10;Lot-C, 50, 90"></textarea>
        <div class="controls">
          <button id="parse-text">â†“ ãƒ†ãƒ¼ãƒ–ãƒ«ã«åæ˜ </button>
          <button id="calc-from-text">ğŸš€ æœ€é©åŒ–ã‚’å®Ÿè¡Œ (Run)</button>
          <button class="ghost" id="clear-text">ã‚¯ãƒªã‚¢</button>
        </div>
      </div>

      <div id="panel-table" style="display:none;">
        <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:12px;">
          <label class="section-label" style="margin:0;">ãƒ­ãƒƒãƒˆæ•°:</label>
          <input id="job-count" type="number" min="1" value="5" style="width:70px;" />
          <button id="gen-rows" class="small-btn">ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ</button>
        </div>

        <div style="overflow:auto; max-height:400px; border:1px solid var(--line); border-radius:4px;">
          <table class="input-table" id="job-table">
            <thead>
              <tr><th style="width:40%">è£½é€ ãƒ­ãƒƒãƒˆå</th><th>ç¬¬1å·¥ç¨‹ (åˆ†)</th><th>ç¬¬2å·¥ç¨‹ (åˆ†)</th><th>æ“ä½œ</th></tr>
            </thead>
            <tbody id="job-tbody"></tbody>
          </table>
        </div>

        <div class="controls">
          <button id="add-row" class="ghost">+ è¡Œã‚’è¿½åŠ </button>
          <button id="calc-from-table">ğŸš€ æœ€é©åŒ–ã‚’å®Ÿè¡Œ (Run)</button>
        </div>
      </div>
    </div>

    <div class="card results" id="results-card" style="display:none;">
      
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
        <label class="section-label" style="font-size:14px; margin:0;">Optimization Impact Analysis</label>
        <button class="ghost small-btn" id="clear-results">Ã— é–‰ã˜ã‚‹</button>
      </div>

      <div class="kpi-board">
        <div class="kpi-card">
          <h3>Before (FIFO)</h3>
          <div class="value" id="kpi-before">0 <span style="font-size:16px; color:var(--muted);">min</span></div>
          <div class="sub">å…¥åŠ›é †ã§ã®ç·æ‰€è¦æ™‚é–“</div>
        </div>
        <div class="kpi-card success">
          <h3>After (Optimized)</h3>
          <div class="value" id="kpi-after">0 <span style="font-size:16px; color:var(--muted);">min</span></div>
          <div class="sub">æœ€é©åŒ–å¾Œã®ç·æ‰€è¦æ™‚é–“</div>
        </div>
        <div class="kpi-card success" style="border-left-color:var(--accent); background:#deebff;">
          <h3>Productivity Gain</h3>
          <div class="value" style="color:var(--accent);">
            <span id="kpi-saved">0</span> <span style="font-size:16px;">min</span>
            <span class="badge badge-green" id="kpi-pct">0% CUT</span>
          </div>
          <div class="sub">çŸ­ç¸®æ™‚é–“ / ç”Ÿç”£æ€§å‘ä¸Šç‡</div>
        </div>
      </div>

      <div class="section">
        <label class="section-label">Recommended Sequence (æ¨å¥¨æŠ•å…¥é †åº)</label>
        <div class="sequence-box">
          <span style="font-size:20px;">ğŸ’¡</span>
          <span id="sequence-text"></span>
        </div>
      </div>

      <div class="section">
        <div style="display:flex; justify-content:space-between; align-items:flex-end;">
          <label class="section-label">Production Gantt Chart</label>
          <button class="small-btn" id="download-img" style="margin-bottom:5px;">ğŸ“· ç”»åƒã¨ã—ã¦ä¿å­˜</button>
        </div>
        <div id="gantt-wrap">
          <canvas id="gantt"></canvas>
        </div>
      </div>

      <div class="section" style="margin-top:30px;">
        <label class="section-label">Schedule Detail Data</label>
        <div id="schedule-area" style="overflow:auto; max-height:300px; border:1px solid var(--line); border-radius:4px;"></div>
      </div>

      <div style="margin-top:24px; border-top:1px solid var(--line); padding-top:20px; text-align:right;">
        <button id="download-csv" class="secondary">ğŸ“¥ CSVãƒ¬ãƒãƒ¼ãƒˆã‚’å‡ºåŠ›</button>
      </div>
    </div>

    <footer style="margin-top:40px; text-align:center; color:var(--muted); font-size:12px; padding-bottom:20px;">
      &copy; 2025 Production Optimizer Tool | Powered by Johnson's Algorithm
    </footer>
  </div>

<script>
/* ----------------------
   JohnsonScheduler - Business Edition
   ---------------------- */
const $ = id => document.getElementById(id);

/* ----- ã‚¿ãƒ–åˆ¶å¾¡ ----- */
const tabText = $('tab-text'), tabTable = $('tab-table');
const panelText = $('panel-text'), panelTable = $('panel-table');
tabText.addEventListener('click', ()=> {
  tabText.classList.add('active'); tabTable.classList.remove('active');
  panelText.style.display='block'; panelTable.style.display='none';
});
tabTable.addEventListener('click', ()=> {
  tabTable.classList.add('active'); tabText.classList.remove('active');
  panelTable.style.display='block'; panelText.style.display='none';
});

/* ----- ãƒ†ãƒ¼ãƒ–ãƒ«æ“ä½œ ----- */
const jobTbody = $('job-tbody');
function makeRow(jobName='', m1=0, m2=0){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input class="job-name" type="text" value="${jobName}" style="width:95%;" /></td>
    <td><input class="m1" type="number" min="0" value="${m1}" style="width:80px;" /></td>
    <td><input class="m2" type="number" min="0" value="${m2}" style="width:80px;" /></td>
    <td><button class="remove small-btn" style="color:var(--danger);">ğŸ—‘</button></td>
  `;
  tr.querySelector('.remove').addEventListener('click', ()=> tr.remove());
  return tr;
}
function genRows(count){
  jobTbody.innerHTML='';
  for(let i=0;i<count;i++){
    const m1 = Math.floor(Math.random()*50)+10;
    const m2 = Math.floor(Math.random()*50)+10;
    jobTbody.appendChild(makeRow(`Lot-${String.fromCharCode(65+i)}`, m1, m2));
  }
}
genRows(5); // åˆæœŸè¡¨ç¤º

$('gen-rows').addEventListener('click', ()=>{
  const n = parseInt($('job-count').value) || 0;
  if(n<1) return;
  genRows(n);
});
$('add-row').addEventListener('click', ()=> {
  const idx = jobTbody.children.length;
  jobTbody.appendChild(makeRow(`Lot-${String.fromCharCode(65+idx) || 'NEW'}`, 20, 20));
});

/* ----- ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ãƒ‘ãƒ¼ã‚¹ ----- */
$('clear-text').addEventListener('click', ()=> { $('text-input').value=''; });
$('parse-text').addEventListener('click', ()=> {
  const text = $('text-input').value.trim();
  if(!text){ alert('å…¥åŠ›ãŒç©ºã§ã™'); return; }
  try{
    const jobs = parseTextData(text);
    jobTbody.innerHTML='';
    jobs.forEach(r=> jobTbody.appendChild(makeRow(r.name, r.m1, r.m2)));
    tabTable.click(); 
  }catch(e){ alert(e.message); }
});

function parseTextData(raw){
  const lines = raw.split(/\r?\n/).map(l=>l.trim()).filter(l=>l && !l.startsWith('#'));
  const rows = [];
  lines.forEach((l,i) => {
    // ã‚«ãƒ³ãƒã€ã‚¹ãƒšãƒ¼ã‚¹ã€ã‚¿ãƒ–ã§åˆ†å‰²
    const parts = l.split(/[, \t]+/).map(p=>p.trim()).filter(Boolean);
    if(parts.length < 2) throw new Error(`è¡Œ${i+1}: ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒä¸æ­£ã§ã™`);
    const name = parts[0];
    const m1 = Number(parts[1]);
    const m2 = Number(parts[2] || 0);
    if(isNaN(m1)||isNaN(m2)) throw new Error(`è¡Œ${i+1}: æ•°å€¤å¤‰æ›ã‚¨ãƒ©ãƒ¼`);
    rows.push({id:i, name, m1, m2});
  });
  return rows;
}
function readTableData(){
  const rows = [];
  Array.from(jobTbody.children).forEach((tr,i)=>{
    const name = tr.querySelector('.job-name').value || `Lot-${i+1}`;
    const m1 = Number(tr.querySelector('.m1').value);
    const m2 = Number(tr.querySelector('.m2').value);
    rows.push({id:i, name, m1, m2});
  });
  if(rows.length===0) throw new Error("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚è¡Œã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚");
  return rows;
}

/* ----- ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ  & è¨ˆç®— ----- */
// Johnson's Algorithm for 2 Machines
function johnson(jobs){
  const list = jobs.map(j => ({...j})); 
  // Group 1: m1 < m2 (æ˜‡é † m1)
  const g1 = list.filter(j => j.m1 < j.m2).sort((a,b) => a.m1 - b.m1);
  // Group 2: m1 >= m2 (é™é † m2)
  const g2 = list.filter(j => j.m1 >= j.m2).sort((a,b) => b.m2 - a.m2);
  return [...g1, ...g2];
}

// Makespan Calculator
function calcSchedule(sequence){
  const schedule = [];
  let t1 = 0, t2 = 0;
  for(const job of sequence){
    const m1s = t1;
    const m1e = m1s + job.m1;
    const m2s = Math.max(m1e, t2); // M2ã¯M1çµ‚äº†å¾Œã‹ã¤å‰ã®M2çµ‚äº†å¾Œ
    const m2e = m2s + job.m2;
    schedule.push({job, m1s, m1e, m2s, m2e});
    t1 = m1e;
    t2 = m2e;
  }
  const makespan = schedule.length ? schedule[schedule.length-1].m2e : 0;
  return {schedule, makespan};
}

/* ----- ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œå‡¦ç† ----- */
let currentResult = null; // ãƒªã‚µã‚¤ã‚ºæ™‚å†æç”»ç”¨

function runCalc(sourceType){
  try{
    let jobs = (sourceType==='text') ? parseTextData($('text-input').value) : readTableData();
    
    // 1. ç¾çŠ¶ï¼ˆå…¥åŠ›é †ï¼‰
    const beforeRes = calcSchedule(jobs);
    
    // 2. æœ€é©åŒ–ï¼ˆJohnsonæ³•ï¼‰
    const optSeq = johnson(jobs);
    const afterRes = calcSchedule(optSeq);

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ä¿å­˜ï¼ˆå†æç”»ãƒ»DLç”¨ï¼‰
    currentResult = afterRes;
    window._lastSchedule = afterRes;

    // 3. è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’å…ˆã«å¯è¦–åŒ– (é‡è¦: Canvasã‚µã‚¤ã‚ºè¨ˆç®—ã®ãŸã‚)
    $('results-card').style.display='block';

    // 4. ãƒ‡ãƒ¼ã‚¿åæ˜ 
    updateKPI(beforeRes.makespan, afterRes.makespan);
    $('sequence-text').textContent = optSeq.map(j=>j.name).join(' â” ');
    renderTable(afterRes);
    drawGantt(afterRes);
    
    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    $('results-card').scrollIntoView({behavior:'smooth', block:'start'});

  }catch(e){ alert('ã‚¨ãƒ©ãƒ¼: ' + e.message); }
}

$('calc-from-text').addEventListener('click', ()=> runCalc('text'));
$('calc-from-table').addEventListener('click', ()=> runCalc('table'));
$('clear-results').addEventListener('click', ()=> $('results-card').style.display='none');

/* ----- KPIè¡¨ç¤º ----- */
function updateKPI(before, after){
  $('kpi-before').textContent = before;
  $('kpi-after').textContent = after;
  
  const saved = before - after;
  const pct = before > 0 ? ((saved / before) * 100).toFixed(1) : 0;
  
  $('kpi-saved').textContent = saved >= 0 ? `-${saved}` : `+${Math.abs(saved)}`;
  $('kpi-pct').textContent = `${pct}% EFFICIENCY`;
  
  if(saved >= 0){
    $('kpi-pct').style.background = 'var(--success)';
  } else {
    $('kpi-pct').style.background = 'var(--danger)'; // æ‚ªåŒ–ã‚±ãƒ¼ã‚¹(è«–ç†çš„ã«ã¯ç¨€ã ãŒ)
    $('kpi-pct').textContent = 'DECREASED';
  }
}

/* ----- æç”»ç³» (Gantt) ----- */
function renderTable(res){
  let html = '<table class="res-table"><thead><tr><th>é †åº</th><th>ãƒ­ãƒƒãƒˆå</th><th>ç¬¬1å·¥ç¨‹ (é–‹å§‹-çµ‚äº†)</th><th>ç¬¬2å·¥ç¨‹ (é–‹å§‹-çµ‚äº†)</th></tr></thead><tbody>';
  res.schedule.forEach((r, idx) => {
    html += `<tr>
      <td>${idx+1}</td>
      <td style="font-weight:600">${r.job.name}</td>
      <td>${r.m1s} - ${r.m1e}</td>
      <td>${r.m2s} - ${r.m2e}</td>
    </tr>`;
  });
  html += '</tbody></table>';
  $('schedule-area').innerHTML = html;
}

function drawGantt(res){
  if(!res) return;
  const canvas = $('gantt');
  const dpr = window.devicePixelRatio || 1;
  const wrap = $('gantt-wrap');
  // è¦ªè¦ç´ ã®å¹…ã‚’å–å¾— (paddingåˆ†ã‚’è€ƒæ…®)
  const w = wrap.clientWidth - 40; 
  const h = 240; 
  
  // ã‚­ãƒ£ãƒ³ãƒã‚¹è¨­å®š
  canvas.width = w * dpr; 
  canvas.height = h * dpr;
  canvas.style.width = w+'px'; 
  canvas.style.height = h+'px';
  
  const ctx = canvas.getContext('2d');
  ctx.scale(dpr,dpr);
  ctx.clearRect(0,0,w,h);
  
  const makespan = res.makespan || 1;
  // ãƒãƒ¼ã‚¸ãƒ³ç¢ºä¿
  const leftPad = 10;
  const rightPad = 30;
  const drawW = w - leftPad - rightPad;
  const scale = drawW / makespan;
  
  const barH = 50;
  const m1Y = 40;
  const m2Y = 130;

  // Grid Drawing
  ctx.strokeStyle = '#eee';
  ctx.lineWidth = 1;
  const step = Math.pow(10, Math.floor(Math.log10(makespan))); // é©å½“ãªåˆ»ã¿å¹…
  for(let x=0; x<=makespan; x+=step){
    const xPos = leftPad + x*scale;
    ctx.beginPath();
    ctx.moveTo(xPos, 20);
    ctx.lineTo(xPos, h - 30);
    ctx.stroke();
    // time label
    ctx.fillStyle = '#999';
    ctx.font = '10px sans-serif';
    ctx.fillText(x, xPos, h - 15);
  }

  // Machine Labels
  ctx.fillStyle = '#172b4d';
  ctx.font = 'bold 12px sans-serif';
  ctx.fillText('Machine 1 (ç¬¬1å·¥ç¨‹)', leftPad, m1Y - 10);
  ctx.fillText('Machine 2 (ç¬¬2å·¥ç¨‹)', leftPad, m2Y - 10);

  // Bars
  res.schedule.forEach((r, i) => {
    // ã‚«ãƒ©ãƒ¼ç”Ÿæˆ: è¦‹ã‚„ã™ãã™ã‚‹ãŸã‚HSLã‚’ä½¿ç”¨
    const hue = (i * 137.5) % 360; 
    const color = `hsla(${hue}, 70%, 55%, 0.9)`;
    const colorBorder = `hsla(${hue}, 70%, 40%, 1.0)`;
    
    // M1 Bar
    drawBar(ctx, leftPad + r.m1s*scale, m1Y, (r.m1e - r.m1s)*scale, barH, color, colorBorder, r.job.name);
    
    // M2 Bar
    drawBar(ctx, leftPad + r.m2s*scale, m2Y, (r.m2e - r.m2s)*scale, barH, color, colorBorder, r.job.name);
    
    // Connection line (flow visibility)
    ctx.beginPath();
    ctx.strokeStyle = 'rgba(0,0,0,0.1)';
    ctx.setLineDash([2, 2]);
    ctx.moveTo(leftPad + r.m1e*scale, m1Y + barH);
    ctx.lineTo(leftPad + r.m2s*scale, m2Y);
    ctx.stroke();
    ctx.setLineDash([]);
  });
  
  // Total Makespan Line
  ctx.strokeStyle = '#ff5630';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(leftPad + makespan*scale, 20);
  ctx.lineTo(leftPad + makespan*scale, h - 30);
  ctx.stroke();
  ctx.fillStyle = '#ff5630';
  ctx.font = 'bold 12px sans-serif';
  ctx.textAlign = 'right';
  ctx.fillText(`Finish: ${makespan}m`, leftPad + makespan*scale, 20);
  ctx.textAlign = 'left'; // reset
}

function drawBar(ctx, x, y, w, h, fill, stroke, text){
  if(w < 1) return;
  // Shadow
  ctx.fillStyle = 'rgba(0,0,0,0.1)';
  ctx.fillRect(x+2, y+2, w, h);
  
  // Body
  ctx.fillStyle = fill;
  ctx.fillRect(x, y, w, h);
  ctx.strokeStyle = stroke;
  ctx.lineWidth = 1;
  ctx.strokeRect(x, y, w, h);
  
  // Text
  if(w > 15){
    ctx.fillStyle = '#fff';
    ctx.font = 'bold 11px sans-serif';
    // text clip
    ctx.save();
    ctx.beginPath();
    ctx.rect(x, y, w, h);
    ctx.clip();
    const metrics = ctx.measureText(text);
    const tx = x + (w - metrics.width)/2;
    const ty = y + h/2 + 4;
    ctx.fillText(text, tx, ty);
    ctx.restore();
  }
}

// Window resize handling
window.addEventListener('resize', ()=>{
  if($('results-card').style.display !== 'none' && currentResult){
    drawGantt(currentResult);
  }
});

/* ----- Output Actions ----- */
$('download-csv').addEventListener('click', ()=>{
  if(!window._lastSchedule) return;
  const h = ['Sequence','LotID','Machine1_Start','Machine1_End','Machine2_Start','Machine2_End'];
  const body = window._lastSchedule.schedule.map((r,i) => [
    i+1, r.job.name, r.m1s, r.m1e, r.m2s, r.m2e
  ].join(',')).join('\n');
  const blob = new Blob([h.join(',')+'\n'+body], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'schedule_optimized.csv';
  document.body.appendChild(a); a.click(); a.remove();
});

$('download-img').addEventListener('click', ()=>{
  const canvas = $('gantt');
  const link = document.createElement('a');
  link.download = 'gantt_chart.png';
  link.href = canvas.toDataURL();
  link.click();
});

// init example
$('text-input').value = 'Lot-A, 30, 10\nLot-B, 15, 40\nLot-C, 20, 20\nLot-D, 50, 30\nLot-E, 10, 50';

</script>
</body>
</html>
